(window.webpackJsonp=window.webpackJsonp||[]).push([["chunk-4809"],{"7OrF":function(e,t,s){"use strict";var a=s("VHEb");s.n(a).a},HTEK:function(e,t,s){"use strict";s.r(t);var a=s("14Xm"),r=s.n(a),o=s("D3Ub"),n=s.n(o),i=s("Mx9/"),l={data:function(){return{hasUpdate:!1,newVersion:{url:"",version_number:"",remarks:""},updateDialogVisible:!1,updateProgressVisible:!1,updateProgress:0,updateProgressValue:"",updateProgressStatus:"检查更新文件",info:""}},watch:{},created:function(){this.getData()},methods:{getData:function(){var e=this;this.$store.dispatch("GetConnect",{url:"configs/index"}).then(function(t){e.info=t.data,1===e.$store.getters.id&&"LOCAL"===i.a.ENV&&e.checkUpdate()}).catch(function(t){e.$message.error(t.msg+",请刷新或联系管理员")})},getHasUpdate:function(){"LOCAL"===i.a.ENV&&(this.$store.dispatch("SetIsUpdate",!0),this.checkUpdate())},checkUpdate:function(){var e=this;this.$store.dispatch("GetConnect",{url:"check"}).then(function(t){1===t.status?(e.hasUpdate=!0,e.$store.getters.isUpdate&&e.$confirm("CRM系统有新发布版本，是否查看更新说明并更新?","更新",{confirmButtonText:"查看更新",cancelButtonText:"以后更新",type:"warning"}).then(function(){e.updateDialogVisible=!0,e.newVersion=t.data}).catch(function(){e.$store.dispatch("SetIsUpdate",!1),e.$alert("可通过系统设置--\x3e站点信息中进行更新","提示",{confirmButtonText:"确定"})})):e.$message.success(t.msg)}).catch(function(t){e.$message.error(t.msg+",请刷新或联系管理员")})},stopWebSite:function(){var e=this;return n()(r.a.mark(function t(){var s,a;return r.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return s="settingOutdated",t.next=3,e.$store.dispatch("GetConnect",{url:s});case 3:a=t.sent,console.log("=========关闭站点========="),console.log(a),0!==a.code&&e.$message.error("关闭站点失败~");case 7:case"end":return t.stop()}},t,e)}))()},doUpdate:function(){var e=this;return n()(r.a.mark(function t(){var s,a,o,n,i,l,u,c,d,p,g,b,h,f,x,m,v,P,_;return r.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:e.queryMatch(204)&&e.stopWebSite(),e.updateProgressVisible=!0,s=0,a="readyDownload",o=null,e.updateProgressStatus="检查更新包...",n=1;case 7:if(!(n<=e.newVersion.number)){t.next=33;break}return i={url:e.newVersion.url,number:n},e.updateProgressValue="检查更新包--\x3e"+n,e.updateProgress=parseFloat((e.updateProgress+15/e.newVersion.number).toFixed(2)),console.log("检查更新包--\x3e"+n),t.next=14,e.$store.dispatch("GetConnect",{url:a,data:i});case 14:return o=t.sent,t.t0=console,t.next=18,o;case 18:if(t.t1=t.sent,t.t0.log.call(t.t0,t.t1),!o.data||1!==o.data.result){t.next=30;break}if(3!==++s){t.next=28;break}return e.$message.error("更新失败,更新包异常,请联系管理员"),e.updateProgressStatus="更新失败...",e.updateProgressValue=o.msg,e.updateProgress=100,t.abrupt("return");case 28:n=0,e.updateProgress=0;case 30:n++,t.next=7;break;case 33:console.log("=========更新包文件名列表========="),console.log(o),a="readyUnzip",e.updateProgressStatus="解压更新文件...",l=0;case 38:if(!(l<o.data.length)){t.next=48;break}return u={file_name:o.data[l]},e.updateProgressValue=o.data[l],e.updateProgress=parseFloat((e.updateProgress+50/o.data.length).toFixed(2)),console.log("=========解压文件--\x3e"+l),t.next=45,e.$store.dispatch("GetConnect",{url:a,data:u});case 45:l++,t.next=38;break;case 48:return a="getDirName",t.next=51,e.$store.dispatch("GetConnect",{url:a});case 51:c=t.sent,console.log("=========更新文件夹目录列表========="),console.log(c),d=null,a="moveDir",e.updateProgressStatus="覆盖更新文件...",p=0;case 58:if(!(p<c.data.length)){t.next=69;break}return g={dirName:c.data[p]},t.next=62,e.$store.dispatch("GetConnect",{url:a,data:g});case 62:d=t.sent,console.log("=========覆盖更新文件夹--\x3e"+p),e.updateProgressValue=c.data[p],e.updateProgress=parseFloat((e.updateProgress+10/c.data.length).toFixed(2));case 66:p++,t.next=58;break;case 69:return console.log("=========覆盖更新完成========="),console.log(d),a="getDbTableNames",t.next=74,e.$store.dispatch("GetConnect",{url:a});case 74:b=t.sent,console.log("=========获取数据库目录列表========="),console.log(b),a="backupsTableName",h=(new Date).getTime(),e.updateProgressStatus="备份数据库数据...",f=0;case 81:if(!(f<b.data.length)){t.next=100;break}x=0;case 83:if(!(x<b.data[f].number)){t.next=97;break}return m={table:b.data[f].table,number:x+1},v=(new Date).getTime(),t.next=88,e.$store.dispatch("GetConnect",{url:a,data:m});case 88:d=t.sent,P=(new Date).getTime(),console.log("=========备份数据库数据"+(f+1)+"--\x3e"+b.data[f].table+"--\x3e"+(x+1)+"--\x3e耗时: "+(P-v)),e.updateProgressStatus="备份数据库数据("+f+"/"+b.data.length+")...",e.updateProgressValue=b.data[f].table+"--\x3e"+(x+1),e.updateProgress=parseFloat((e.updateProgress+20/b.data.length/b.data[f].number).toFixed(2));case 94:x++,t.next=83;break;case 97:f++,t.next=81;break;case 100:return console.log("=========备份数据库数据完成========="),e.updateProgress=parseFloat((e.updateProgress+20).toFixed(2)),_=(new Date).getTime(),console.log("总耗时: "+(_-h)/1e3),console.log(d),a="updateDatabase",e.updateProgressStatus="更新数据库文件...",t.next=109,e.$store.dispatch("GetConnect",{url:a});case 109:d=t.sent,e.updateProgressValue="更新中...",e.updateProgress=parseFloat((e.updateProgress+5).toFixed(2)),console.log("=========更新数据库文件完成========="),console.log(d),0===d.code?(e.updateProgressStatus="已完成...",e.updateProgressValue="",e.updateProgress=100):(e.updateProgressStatus="更新失败...",e.updateProgressValue=d.msg,e.updateProgress=100);case 115:case"end":return t.stop()}},t,e)}))()},refresh:function(){this.$router.go(0)}}},u=(s("7OrF"),s("KHd+")),c=Object(u.a)(l,function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"app-container  bg-gray"},[s("el-card",[s("el-row",[s("div",{staticClass:"header"},[e._v("系统信息")])]),e._v(" "),e._l(e.info,function(t,a){return s("el-row",{key:a},[s("el-col",{attrs:{sm:8,md:7,lg:6,xl:4}},[e._v(e._s(t.con_name))]),e._v(" "),s("el-col",{attrs:{sm:16,md:17,lg:18,xl:20}},[e._v(e._s(t.con_value)+"\n        "),1===a&&1===e.$store.getters.id?s("el-button",{attrs:{type:"text"},on:{click:e.getHasUpdate}},[e._v("检查更新")]):e._e(),e._v(" "),1===a&&e.hasUpdate&&1===e.$store.getters.id?s("el-button",{attrs:{type:"text"},on:{click:e.getHasUpdate}},[e._v("（有新版本, 点击更新）")]):e._e()],1)],1)})],2),e._v(" "),s("el-dialog",{attrs:{visible:e.updateDialogVisible,"modal-append-to-body":!1,title:"系统更新说明",width:"1080px"},on:{"update:visible":function(t){e.updateDialogVisible=t}}},[s("div",{domProps:{innerHTML:e._s(e.newVersion.remarks)}},[e._v(e._s(e.newVersion.remarks||"暂无更新内容说明"))]),e._v(" "),s("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[s("el-button",{on:{click:function(t){e.updateDialogVisible=!1}}},[e._v("以 后 更 新")]),e._v(" "),s("el-button",{attrs:{type:"primary"},on:{click:e.doUpdate}},[e._v("确 定 更 新")])],1)]),e._v(" "),s("el-dialog",{attrs:{visible:e.updateProgressVisible,"show-close":!1,"close-on-press-escape":!1,"close-on-click-modal":!1,"modal-append-to-body":!1,title:"更新中...",width:"520px"},on:{"update:visible":function(t){e.updateProgressVisible=t}}},[s("el-progress",{attrs:{"text-inside":!0,"stroke-width":26,percentage:e.updateProgress}}),e._v(" "),s("div",{staticClass:"progress-status"},[e._v(e._s(e.updateProgressStatus+"..."))]),e._v(" "),s("div",{staticClass:"progress-value"},[e._v(e._s(e.updateProgressValue))]),e._v(" "),s("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[100===e.updateProgress?s("el-button",{attrs:{type:"primary"},on:{click:e.refresh}},[e._v("立即刷新")]):e._e()],1)],1)],1)},[],!1,null,"75f84cad",null);c.options.__file="siteInfo.vue";t.default=c.exports},VHEb:function(e,t,s){}}]);